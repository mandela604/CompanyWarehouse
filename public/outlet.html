<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Outlet Rep — WareAdmin</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <style>
    :root{--blue:#0b5ed7;--dark-red:#b71c1c;--bg:#f6f8fb;--card:#ffffff;--muted:#6b7280;--shadow:0 6px 18px rgba(11,94,215,0.08);--radius:12px}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,sans-serif;background:linear-gradient(180deg,var(--bg),#eef3fb);color:#111827}
    .app{display:grid;grid-template-columns:260px 1fr;min-height:100vh;gap:20px;padding:20px}
    @media (max-width:900px){.app{grid-template-columns:1fr}}
    .sidebar{background:linear-gradient(180deg,var(--card),#fbfdff);border-radius:16px;padding:18px;box-shadow:var(--shadow);height:calc(100vh - 40px);position:sticky;top:20px;display:flex;flex-direction:column}
    .brand{display:flex;gap:12px;align-items:center;margin-bottom:8px}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--blue),var(--dark-red));display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:20px}
    .nav{flex:1}
    .nav a{display:flex;gap:12px;align-items:center;padding:10px;border-radius:10px;color:#0f172a;text-decoration:none;margin-bottom:6px}
    .nav a.active{background:linear-gradient(90deg,rgba(11,94,215,0.08),rgba(183,17,28,0.03))}
    .nav .user-info{margin:20px 0;color:var(--muted);font-size:14px}
    .nav .logout-btn{width:100%;margin-top:10px}
    .hamburger{display:none;position:fixed;left:14px;top:14px;background:var(--card);padding:8px;border-radius:8px;box-shadow:0 8px 22px rgba(2,6,23,0.08);z-index:40;cursor:pointer}
    @media (max-width:900px){.sidebar{position:fixed;left:-320px;top:0;height:100vh;transition:left .25s;z-index:40} .sidebar.open{left:0} .hamburger{display:block}}
    main{padding:6px 0}
    .topbar{display:none} /* Hidden now — everything in sidebar */
    .btn{padding:10px 14px;border-radius:10px;border:none;background:var(--blue);color:white;cursor:pointer;font-weight:600}
    .btn.secondary{background:transparent;border:1px solid #ddd;color:#333}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:20px}
    @media (max-width:1100px){.grid{grid-template-columns:repeat(2,1fr)}}
   @media (max-width:760px){.grid{grid-template-columns:repeat(2,1fr)}}
    .card{background:var(--card);border-radius:14px;padding:18px;box-shadow:var(--shadow);border:1px solid #e5e7eb;position:relative;overflow:hidden}
    .card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,var(--blue),var(--dark-red))}
    .card:hover{transform:translateY(-4px);box-shadow:0 16px 32px rgba(11,94,215,0.15)}
    .card h3{margin:0 0 6px;font-size:13px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px}
    .card .value{font-size:24px;font-weight:700}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th{background:#f8fafc;color:var(--muted);font-weight:600;padding:14px 12px;text-align:left;font-size:11px}
    td{padding:14px 12px;border-bottom:1px solid #eef3fb}
    tr:hover{background:rgba(11,94,215,0.03)}
    .pagination{margin:20px 0;display:flex;gap:8px;justify-content:center;align-items:center}
    .pagination button{padding:8px 12px;border:1px solid #ddd;background:white;border-radius:8px;cursor:pointer}
    .pagination button:disabled{background:#f0f0f0;color:#999;cursor:not-allowed}
    .pagination button.active{background:var(--blue);color:white;border-color:var(--blue)}
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.35);display:none;align-items:center;justify-content:center;z-index:60}
    .modal{background:white;border-radius:12px;padding:24px;min-width:340px;max-width:500px;box-shadow:0 20px 40px rgba(0,0,0,0.2)}
    .form-row{margin:12px 0}
    .form-row label{display:block;margin-bottom:6px;font-weight:600}
    .form-row select,.form-row input{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd}
    .success{background:#d4edda;color:#155724;padding:12px;border-radius:8px;margin:12px 0;display:none}
    .section{display:none}
    .section.active{display:block}
    .receive-btn{background:#10b981;color:white;padding:6px 12px;border:none;border-radius:8px;cursor:pointer;font-size:11px}
  
  
  /* CENTERED & PERFECTLY ALIGNED INCOMING SHIPMENTS TABLE (Outlet Rep) */
#shipmentsTable {
  table-layout: fixed;  /* Prevents column shifting */
  width: 100%;
}

#shipmentsTable th,
#shipmentsTable td {
  text-align: center !important;
  vertical-align: middle;
  padding: 12px 8px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Balanced column widths (adds up to 100%) */
#shipmentsTable th:nth-child(1), #shipmentsTable td:nth-child(1) { width: 14%; } /* Date */
#shipmentsTable th:nth-child(2), #shipmentsTable td:nth-child(2) { width: 18%; } /* From */
#shipmentsTable th:nth-child(3), #shipmentsTable td:nth-child(3) { width: 12%; } /* Product */
#shipmentsTable th:nth-child(4), #shipmentsTable td:nth-child(4) { width: 10%; } /* Qty */
#shipmentsTable th:nth-child(5), #shipmentsTable td:nth-child(5) { width: 15%; } /* Total Value */
#shipmentsTable th:nth-child(6), #shipmentsTable td:nth-child(6) { width: 12%; } /* Status */
#shipmentsTable th:nth-child(7), #shipmentsTable td:nth-child(7) { width: 19%; } /* Action */



/* Mobile: fit everything without horizontal scroll */
@media (max-width: 768px) {
  .app {
    padding: 12px;
    gap: 12px;
  }

  .grid {
    grid-template-columns: 1fr;           /* Stack overview cards */
    gap: 12px;
  }

  .card {
    padding: 12px;
  }

  table {
    width: 100%;
    min-width: 0;
    table-layout: auto;
  }

  th, td {
    padding: 8px 6px;
    font-size: 12px;
    white-space: normal;                /* Allow text to wrap */
    word-break: break-word;
  }

  /* Give product column more breathing room */
  #shipmentsTable th:nth-child(3),
  #shipmentsTable td:nth-child(3),
  #fullSalesTable th:nth-child(3),
  #fullSalesTable td:nth-child(3) {
    min-width: 120px;
  }

  .pagination button {
    padding: 6px 10px;
    font-size: 12px;
  }

  .btn {
    padding: 8px 12px;
    font-size: 13px;
  }
}

/* Very small phones */
@media (max-width: 480px) {
  .card {
    padding: 10px;
  }

  th, td {
    padding: 6px 4px;
    font-size: 11px;
  }
}


/* Make rep filter look identical to date picker */
#repFilter,
.sales-filter-input {
  height: 42px !important;
  padding: 10px 12px !important;
  border: 1px solid #e6eefb !important;
  border-radius: 10px !important;
  font-size: 14px !important;
  background: white !important;
  min-width: 180px !important;
  box-sizing: border-box !important;
  appearance: none; /* remove default arrow */
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%236b7280' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  background-size: 12px;
}

/* Remove default arrow in Firefox */
#repFilter::-moz-focus-inner,
.sales-filter-input::-moz-focus-inner {
  border: 0;
}

/* Hover & focus states (same as date picker) */
#repFilter:focus,
.sales-filter-input:focus {
  outline: none;
  border-color: var(--blue) !important;
  box-shadow: 0 0 0 3px rgba(11,94,215,0.1);
}


#outletShipmentReportTable th:nth-child(3),
#outletShipmentReportTable th:nth-child(4) {
  text-align: center !important;
}

#outletShipmentReportTable td:nth-child(3) {
  text-align: center !important;
}

#outletShipmentReportTable td:nth-child(4) {
  text-align: right !important;
}

/* Align shipment breakdown table columns */
#outletShipmentReportTable th:nth-child(1),
#outletShipmentReportTable td:nth-child(1) { text-align: left; } /* From */

#outletShipmentReportTable th:nth-child(2),
#outletShipmentReportTable td:nth-child(2) { text-align: left; } /* Products */

#outletShipmentReportTable th:nth-child(3),
#outletShipmentReportTable td:nth-child(3) { text-align: center; } /* Total Qty */

#outletShipmentReportTable th:nth-child(4),
#outletShipmentReportTable td:nth-child(4) { text-align: right; } /* Total Value */

#outletShipmentReportTable th:nth-child(5),
#outletShipmentReportTable td:nth-child(5) { text-align: center; } /* Status - centers the pill */



/* ────────────────────────────────────────────────────────────────
   MOBILE RESPONSIVE IMPROVEMENTS
─────────────────────────────────────────────────────────────────── */

/* Tablets & small laptops — overview cards 2 per row */
@media (max-width: 1100px) {
  .grid {
    grid-template-columns: repeat(2, 1fr); /* 2 cards per row */
    gap: 14px;
  }
}

/* Phones & small screens — overview cards stack to 1 per row */
@media (max-width: 768px) {
  .app {
    padding: 12px;
    gap: 12px;
  }

  .grid {
    grid-template-columns: 1fr; /* 1 card per row on phones */
    gap: 12px;
  }

  .card {
    padding: 14px;
  }

  .card h3 {
    font-size: 12px;
  }

  .card .value {
    font-size: 20px;
  }

  /* Tables — make them scrollable horizontally if needed, better readability */
  table {
    display: block;
    overflow-x: auto;
    white-space: nowrap;
    -webkit-overflow-scrolling: touch; /* smooth scroll on iOS */
  }

  th, td {
    padding: 10px 8px;
    font-size: 13px;
    min-width: 100px; /* prevent columns from collapsing too much */
  }

  /* Fix product column breathing room in tables */
  #shipmentsTable th:nth-child(3),
  #shipmentsTable td:nth-child(3),
  #fullSalesTable th:nth-child(3),
  #fullSalesTable td:nth-child(3),
  #fullInventoryTable th:nth-child(1),
  #fullInventoryTable td:nth-child(1) {
    min-width: 140px;
  }

  .pagination {
    flex-wrap: wrap;
    gap: 6px;
  }

  .pagination button {
    padding: 8px 10px;
    font-size: 13px;
    min-width: 40px;
  }

  .btn {
    padding: 10px 14px;
    font-size: 14px;
  }

  h2 {
    font-size: 1.5rem;
    margin-top: 12px;
  }
}

/* Very small phones (≤480px) — tighter spacing */
@media (max-width: 480px) {
  .app {
    padding: 10px;
  }

  .card {
    padding: 12px;
  }

  .card h3 {
    font-size: 11px;
  }

  .card .value {
    font-size: 18px;
  }

  th, td {
    padding: 8px 6px;
    font-size: 12px;
  }

  .btn {
    padding: 10px 12px;
    font-size: 13px;
  }

  /* Sidebar hamburger & nav items smaller */
  .hamburger {
    padding: 10px;
    font-size: 1.4rem;
  }

  .nav a {
    padding: 8px;
    font-size: 14px;
  }
}

/* ────────────────────────────────────────────────────────────────
   RECORD SALE MODAL — Fully mobile friendly
─────────────────────────────────────────────────────────────────── */

@media (max-width: 768px) {
  .modal-backdrop .modal {
    width: 95%;
    max-width: none;
    margin: 10px;
    padding: 16px;
    max-height: 90vh;
    overflow-y: auto;
  }

  /* Stack form rows vertically */
  .form-row {
    margin: 16px 0;
  }

  /* Full-width inputs & buttons */
  #productSelect,
  #qtyInput,
  .btn {
    width: 100%;
    font-size: 15px;
    padding: 12px;
  }

  /* Make add item button full width on small screens */
  #addItemBtn {
    width: 100%;
    margin-top: 12px;
  }

  /* Table inside modal — scrollable if many items */
  #modalBackdrop table {
    display: block;
    overflow-x: auto;
    white-space: nowrap;
  }

  #modalBackdrop th,
  #modalBackdrop td {
    padding: 10px 8px;
    font-size: 14px;
    min-width: 90px;
  }

  /* Grand total bigger & centered on mobile */
  #grandTotal {
    font-size: 1.6rem;
    display: block;
    text-align: center;
    margin: 16px 0;
  }

  /* Buttons stack vertically */
  .modal > div:last-child {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .modal > div:last-child button {
    width: 100%;
  }
}

@media (max-width: 480px) {
  #modalBackdrop .modal {
    padding: 12px;
  }

  #modalBackdrop h3 {
    font-size: 1.3rem;
  }

  #modalBackdrop table th,
  #modalBackdrop table td {
    font-size: 13px;
    padding: 8px 6px;
  }
}

  </style>


<div class="modal-backdrop" id="emptyModalBackdrop">
  <div class="modal" id="modal"></div>
</div>


</head>
<body>

  <button class="hamburger" id="hambBtn">☰ Menu</button>

  <div class="app">
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <div class="logo">O</div>
        <div>
          <h2>Outlet Rep</h2>
          <div class="small" id="outletDisplay" style="color:var(--muted)"></div>
        </div>
      </div>
      <div class="nav">
        <a href="#" class="active" data-route="overview">Overview</a>
        <a href="#" data-route="inventory">My Inventory</a>
        <a href="#" data-route="sales">Sales History</a>
        <a href="#" data-route="shipments">Incoming Shipments</a>
        <a href="#" data-route="salesReport">Sales Breakdown Report</a>
        <a href="#" data-route="outletShipmentReport">Incoming Shipment Breakdown</a>
        <div class="user-info"></div>
         <button class="btn secondary logout-btn" onclick="logout()">Logout</button>
      </div>
      <button class="btn" id="recordSaleBtn">+ Record Sale</button>
    </aside>

    <main>
      <!-- OVERVIEW -->
      <section id="overviewSection" class="section active">
        <div class="grid">
          <div class="card"><h3>Total Stock</h3><div class="value" id="totalStock">0</div><div style="color:var(--muted)">units</div></div>
          <div class="card"><h3>Today's Sales</h3><div class="value" id="todaySales">₦0</div></div>
          <div class="card"><h3>Total Revenue</h3><div class="value" id="totalRevenue">₦0</div></div>
          <div class="card"><h3>Incoming Today</h3><div class="value" id="pendingShipments">0</div></div>
        </div>
        <div class="card"><h3>Quick Inventory</h3><table id="quickInventory">
    <thead>
      <tr>
        <th>Product</th>
        <th>In Stock</th>
        <th>Unit Price</th>
      </tr>
    </thead>
    <tbody></tbody></table></div>
        <div class="card"><h3>Recent Sales</h3><table id="recentSales">
    <thead>
      <tr>
        <th>Date</th>
        <th>Product</th>
        <th>Qty</th>
        <th>Amount</th>
      </tr>
    </thead>
    <tbody></tbody></table></div>
      </section>

      <!-- INVENTORY -->
      <section id="inventorySection" class="section">
        <h2>My Inventory</h2>
        <div class="card">
          <table id="fullInventoryTable"><thead><tr><th>Product</th><th>SKU</th><th>In Stock</th><th>Price</th><th>Value</th><th>History</th></tr></thead><tbody></tbody></table>
          <div class="pagination" id="inventoryPagination"></div>
        </div>
      </section>

      <!-- SALES -->
      <section id="salesSection" class="section">
        <h2>Sales History</h2>
        <button id="printOutletSalesBtn" class="btn" style="background:var(--blue); color:white; padding:11px 20px; font-size:14px; border-radius:12px; box-shadow:0 4px 12px rgba(11,94,215,0.25);">
      Print This Page
    </button>
        <div class="filter-bar">
          <input type="date" id="filterStart"><input type="date" id="filterEnd">
          <button class="btn secondary" onclick="applySalesFilter()">Apply</button>
          <button class="btn secondary" onclick="clearSalesFilter()">Clear</button>
        </div>
        <div class="card">
          <table id="fullSalesTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Time</th>
              <th>products</th>
              <th>Total Qty</th>
              <th>Amount</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="pagination" id="salesPagination"></div>
        </div>
      </section>

      <!-- SHIPMENTS -->
      <section id="shipmentsSection" class="section">
        <h2>Incoming Shipments</h2>
        <div class="card">
          <table id="shipmentsTable">
            <thead><tr><th>Date</th><th>From</th><th>Product</th><th>Qty</th> <th>Total Value</th><th>Status</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="pagination" id="shipmentsPagination"></div>
        </div>
      </section>


      <!-- SALES BREAKDOWN REPORT (Outlet Rep) -->
<section id="salesReportSection" class="section">
  <h2 style="margin-top:0">Sales Breakdown Report</h2>

  <!-- Filters (same style as warehouse/manager) -->
  <div style="margin:24px 0 32px; display:flex; gap:16px; flex-wrap:wrap; align-items:center; justify-content:space-between; background:white; padding:20px; border-radius:12px; box-shadow:var(--shadow);">
    <div style="display:flex; gap:12px; flex-wrap:wrap;">
      <div id="outletSalesDateContainer" style="min-width:240px;"></div>
      <select id="repFilter" class="sales-filter-input">
  <option value="">All Reps</option>
</select>
      <!-- No need for outlet filter — it's always this outlet -->
      <button class="btn secondary" onclick="clearOutletSalesFilters()">Clear Filters</button>
      <div class="small muted" id="outletSalesDateDisplay">All time</div>
    </div>
    <button id="printOutletSalesReportBtn" class="btn" style="background:var(--blue);color:white;min-width:140px;">
      Print This Page
    </button>
  </div>

  <!-- Main Table -->
  <div class="table">
      <div style="margin: 16px 0; font-size: 15px; font-weight: 600; color: #111827; text-align: center;">
  Products Sold 
  <span id="outletCurrentPeriodDisplay" style="color: var(--blue);"></span>
</div>
    <table id="outletSalesReportTable">
      <thead>
        <tr>
          <th>Product</th>
          <th style="text-align:center;">Total Qty Sold</th>
          <th style="text-align:right;">Total Value</th>
          <th>Rep</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="pagination" id="outletSalesPagination"></div>
  </div>
</section>


<!-- ==================== OUTLET INCOMING SHIPMENT BREAKDOWN REPORT ==================== -->
<section id="outletShipmentReportSection" class="section">
  <h2 style="margin-top:0">Incoming Shipment Breakdown Report</h2>
  <!-- Filters (simplified – only date + status, no type/outlet since it's always this outlet) -->
  <div style="margin:24px 0 32px; display:flex; gap:16px; flex-wrap:wrap; align-items:center; justify-content:space-between; background:white; padding:20px; border-radius:12px; box-shadow:var(--shadow);">
    <div style="display:flex; gap:12px; flex-wrap:wrap;">
      <div id="outletShipmentDateContainer" style="min-width:240px;"></div>
      <select id="outletShipmentWarehouseFilter" class="sales-filter-input">
        <option value="">All Warehouses</option>
      </select>
      <select id="outletShipmentStatusFilter" class="sales-filter-input">
        <option value="">All Statuses</option>
        <option value="In Transit">In Transit</option>
        <option value="Received">Received</option>
        <option value="cancelled">Cancelled</option>
        <option value="Rejected">Rejected</option>
      </select>
      <button class="btn secondary" onclick="clearOutletShipmentFilters()">Clear Filters</button>
      <div class="small muted" id="outletShipmentDateDisplay">All time</div>
    </div>
    <button id="printOutletShipmentReportBtn" class="btn" style="background:var(--blue);color:white;min-width:140px;">
      Print This Page
    </button>
  </div>
  <!-- Main Table -->
  <div class="table">
    <div style="margin: 16px 0; font-size: 15px; font-weight: 600; color: #111827; text-align: center;">
      Products Received
      <span id="outletShipmentCurrentPeriodDisplay" style="color: var(--blue); font-weight: normal;">(loading...)</span>
    </div>
    <table id="outletShipmentReportTable">
      <thead>
        <tr>
          <th>From</th>
          <th>Products</th>
          <th>Total Qty</th>
          <th>Total Value</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="pagination" id="outletShipmentPagination"></div>
  </div>
</section>


<!-- PRODUCT SHIPMENT HISTORY (for Outlet Rep) -->
<section id="productHistorySection" class="section">
  <h2 id="productHistoryTitle">Shipment History</h2>
  <button class="btn secondary" onclick="navigateTo('inventory')" style="margin-bottom:16px;">
    ← Back to Inventory
  </button>
  <button class="btn" id="printHistoryBtn" style="margin-bottom:16px; background:#0b5ed7; color:white;">
    Print History
  </button>
  <div class="card">
    <table id="productHistoryTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>From</th>
          <th>Qty</th>
          <th>Status</th>
          <th>Shipment ID</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="pagination" id="historyPagination"></div>
  </div>
</section>






    </main>
  </div>

<!-- Sales modal -->
<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal" style="min-width:600px;max-width:800px;">
    <h3>Record Sale (Multiple Products)</h3>
    <div id="successMsg" class="success" style="display:none;">Sale recorded!</div>

    <table style="width:100%;margin:16px 0;">
      <thead>
        <tr style="background:#f8fafc;">
          <th style="text-align:left;padding:10px;">Product</th>
          <th style="width:100px;">Qty</th>
          <th style="width:120px;">Price</th>
          <th style="width:100px;">Total</th>
          <th style="width:40px;"></th>
        </tr>
      </thead>
      <tbody id="saleItems"></tbody>
    </table>

    <div class="form-row">
      <select id="productSelect" style="width:100%;padding:10px;"></select>
    </div>
    <div class="form-row" style="display:flex;gap:10px;align-items:end;">
      <div style="flex:1;">
        <label>Quantity</label>
        <input type="number" id="qtyInput" min="1" value="1" style="width:100%;">
      </div>
      <button class="btn secondary" id="addItemBtn" style="height:42px;">+ Add Item</button>
    </div>

    <div style="margin-top:16px;text-align:right;font-size:18px;font-weight:600;">
      Grand Total: <span id="grandTotal">₦0</span>
    </div>

    <div style="text-align:right;margin-top:20px;">
      <button class="btn secondary" onclick="closeModal()">Cancel</button>
      <button class="btn" id="confirmSale" disabled>Complete Sale</button>
    </div>
  </div>
</div>

 
  
  <div id="toastContainer" style="
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  display: flex;
  flex-direction: column;
  gap: 8px;
  z-index: 1000;
  pointer-events: none; /* Allows clicks to pass through */
"></div>


<div class="modal-backdrop" id="viewModal">
  <div class="modal" style="max-width:700px;">
    <h3>Sale Details</h3>
    <div style="margin-bottom:16px;color:#666;">
      Date: <strong id="saleDate"></strong> | 
      Items: <strong id="itemCount"></strong>
    </div>

    <table style="width:100%;margin:16px 0;">
      <thead style="background:#f0f0f0;">
        <tr>
          <th style="text-align:left;padding:10px;">Product</th>
          <th style="width:80px;">Qty</th>
          <th style="width:120px;">Unit Price</th>
          <th style="width:120px;">Line Total</th>
        </tr>
      </thead>
      <tbody id="viewItems"></tbody>
    </table>

    <div style="text-align:right;margin:20px 0;font-size:20px;font-weight:700;">
      Grand Total: <span class="grand-total" style="color:var(--blue);">₦0</span>
    </div>

    <div style="text-align:right;">
      <button class="btn secondary" onclick="printSale()">Print Receipt</button>
      <button class="btn secondary" style="margin-left:8px;" onclick="$('#viewModal').style.display='none'">Close</button>
    </div>
  </div>
</div>

<!-- Dedicated Print Preview Modal -->
<div class="modal-backdrop" id="printPreviewBackdrop" style="display:none;">
  <div class="modal" style="max-width:900px; width:90%; max-height:90vh;">
    <div id="printPreviewContent"></div>
    <div style="text-align:right; margin-top:20px;">
      <button class="btn secondary" onclick="closePrintPreview()">Cancel</button>
      <button class="btn" style="background:#0b5ed7; color:white;" onclick="window.print()">Print Now</button>
    </div>
  </div>
</div>


  <script>
    let currentUser = { role: 'rep' }; // default fallback


const params = new URLSearchParams(window.location.search);
if (params.get('select')) {

  let outlets = [];

  try {

    const raw = params.get('outlets');

    if (raw) {

      outlets = JSON.parse(decodeURIComponent(raw));

    }

  } catch (e) {

    console.error('Failed to parse outlets:', e);

    document.body.innerHTML = `<div style="text-align:center;padding:50px;">

      <h3>Error loading outlets</h3>

      <p><a href="/login.html">Back to login</a></p>

    </div>`;

  }

  // Fetch user name

  fetch('/api/auth/me')

    .then(res => res.json())

    .then(user => {

      let html = `<div style="text-align:center;padding:60px;background:#f8f9fa;border-radius:16px;margin:40px auto;max-width:500px;">

        <h2>Welcome, ${user.name || 'Rep'}!</h2>

        <p style="color:#666;margin:20px 0;">Please select an outlet to manage:</p>`;

      if (outlets.length === 0) {

        html += `<p>No outlets assigned.</p>`;

      } else {

        outlets.forEach(o => {

          html += `<button onclick="selectOutlet('${o.id}')" 

            style="display:block;width:100%;max-width:360px;margin:16px auto;padding:16px;font-size:16px;

                   border-radius:12px;background:var(--blue);color:white;border:none;

                   cursor:pointer;box-shadow:0 4px 12px rgba(11,94,215,0.2);">

            <div><strong>${o.name}</strong></div>

            <div style="font-size:13px;margin-top:4px;color:rgba(255,255,255,0.8);">

              ${o.location || 'No location'}

            </div>

          </button>`;

        });

      }

      html += `<div style="margin-top:40px;"><a href="/login.html" style="color:var(--muted);text-decoration:underline;">← Back to login</a></div>

      </div>`;

      document.body.innerHTML = html;

    })

    .catch(err => {

      console.error(err);

      document.body.innerHTML = `<div style="text-align:center;padding:50px;">

        <h3>Session error</h3>

        <p><a href="/login.html">Login again</a></p>

      </div>`;

    });

}

function selectOutlet(id) {
  fetch('/api/select-outlet', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ outletId: id })
  }).then(() => location.href = '/outlet.html');
}

const urlParams = new URLSearchParams(window.location.search);
let OUTLET_ID = urlParams.get('outletId'); 

async function loadCurrentOutletId() {
  try {
    const res = await fetch('/api/auth/me');
    if (!res.ok) return null;
    const user = await res.json();
    return user.currentOutletId;
  } catch {
    return null;
  }
}


function logout() {
  fetch('/api/logout', {
    method: 'POST',
    credentials: 'include'
  })
  .then(res => res.json())
  .then(data => window.location.href = data.redirect);
}

async function loadUserInfo() {
  try {
    const res = await fetch('/api/auth/me');
    if (!res.ok) throw new Error('Failed to get user');
    const user = await res.json();
    currentUser = user;
    const userInfo = document.querySelector('.user-info');
    userInfo.innerHTML = `Signed in as<br><strong>${user.name}</strong>`;
  } catch (err) {
    console.error(err);
  }
}

if (!params.get('select')) {
  loadUserInfo();
}


// Toast function
function showToast(message, type = 'info', duration = 3000) {
  const container = document.getElementById('toastContainer');
  if (!container) return;

  const colors = { info: '#0b5ed7', success: '#10b981', error: '#b71c1c' };
  const toast = document.createElement('div');
  toast.textContent = message;
  toast.style.background = colors[type] || colors.info;
  toast.style.color = 'white';
  toast.style.padding = '10px 16px';
  toast.style.borderRadius = '8px';
  toast.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
  toast.style.opacity = '0';
  toast.style.transition = 'opacity 0.3s, transform 0.3s';
  toast.style.transform = 'translateY(20px)';

  container.appendChild(toast);

  requestAnimationFrame(() => {
    toast.style.opacity = '1';
    toast.style.transform = 'translateY(0)';
  });

  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateY(20px)';
    toast.addEventListener('transitionend', () => toast.remove());
  }, duration);
}

    const ITEMS_PER_PAGE = 10;
    const SALES_PER_PAGE = 10;
    let curInv = 1;
    let curSales = 1;
    let fullInventory = [];
    let salesFilter = { start: null, end: null };

    function $(s){return document.querySelector(s)}
    function formatNGN(n){return '₦'+(n||0).toLocaleString()}


    function niceDate(d) {
    const date = new Date(d);
    return date.toLocaleDateString(); // or format as needed
  }

    function navigateTo(r){
      document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
      $(`#${r}Section`).classList.add('active');
      document.querySelectorAll('.nav a').forEach(a=>a.classList.remove('active'));
      const navLink = document.querySelector(`.nav a[data-route="${r}"]`);
      if (navLink) {
        navLink.classList.add('active');
      }
      if(r==='inventory') renderOutletInventory();
      if(r==='sales') loadSales();
      if(r==='shipments') renderShipments();
      if (r === 'salesReport') {
      $('#salesReportSection').classList.add('active');
      if (!outletSalesPicker) initOutletSalesDatePicker();
      loadRepFilter();
      renderOutletSalesReport();
       }
      if (r === 'outletShipmentReport') {
        if (!outletShipmentPicker) initOutletShipmentDatePicker();
        loadOutletShipmentFilters();
        renderOutletShipmentReport();
        }
      }
    document.querySelectorAll('.nav a').forEach(a=>a.addEventListener('click',e=>{e.preventDefault();navigateTo(a.dataset.route)}));
    $('#hambBtn').onclick=()=>$('#sidebar').classList.toggle('open');



async function loadOutletInfo() {
  try {
    let url = '/api/outlet/inventory';
    if (OUTLET_ID) {
      url += `?outletId=${OUTLET_ID}`;
    }

    const res = await fetch(url);
    if (!res.ok) throw new Error('Failed');
    const data = await res.json();

    OUTLET_ID = data.outletId;

    // Dynamically set the outlet name in the sidebar
    const outletDisplay = document.getElementById('outletDisplay');
    if (outletDisplay) {
      outletDisplay.textContent = `${data.outletName} • ${data.location}`;
    }

    return data.products || [];
  } catch (err) {
    console.error(err);
    showToast('Failed to load outlet info', 'error');
    return [];
  }
}


function viewSale(groupId) {
  const sale = window.lastSalesData?.data.find(s => s.id === groupId);
  if (!sale) return showToast('Sale not found', 'error');

  // Set date, time, items count, and recorded by (if repName available)
  $('#saleDate').textContent = `${sale.date} ${sale.time} | Recorded by: ${sale.repName || '—'}`;
  $('#itemCount').textContent = `${sale.itemCount} item${sale.itemCount > 1 ? 's' : ''}`;

  // Build items table
  let itemsHTML = '';
  let grandTotal = 0;

  sale.items.forEach(item => {
    const lineTotal = item.qty * item.unitPrice;
    grandTotal += lineTotal;

    itemsHTML += `
      <tr>
        <td><strong>${item.productName}</strong></td>
        <td style="text-align:center;">${item.qty}</td>
        <td style="text-align:right;">₦${item.unitPrice.toLocaleString()}</td>
        <td style="text-align:right;font-weight:600;">₦${lineTotal.toLocaleString()}</td>
      </tr>
    `;
  });

  $('#viewItems').innerHTML = itemsHTML;
  $('#viewModal .grand-total').textContent = '₦' + grandTotal.toLocaleString();
  $('#viewModal').style.display = 'flex';
}

  async function renderOutletOverview() {
  const stockEl = $('#totalStock');
  const todaySalesEl = $('#todaySales');
  const totalRevenueEl = $('#totalRevenue');
  const incomingEl = $('#pendingShipments');

  // table bodies
  const quickInvBody = $('#quickInventory tbody');
  const recentSalesBody = $('#recentSales tbody');

  // show loading
  stockEl.textContent = '...';
  todaySalesEl.textContent = '...';
  totalRevenueEl.textContent = '...';
  incomingEl.textContent = '...';

  try {

    let url = '/api/outlet/overview';
    if (OUTLET_ID) {
      url += `?outletId=${OUTLET_ID}`;
    }

    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const data = await res.json();
  
    // top cards
    stockEl.textContent = data.outletStock || 0;
    todaySalesEl.textContent = formatNGN(data.todaySales || 0);
    totalRevenueEl.textContent = formatNGN(data.totalRevenue || 0);
    incomingEl.textContent = data.incomingShipments || 0;

    // quick inventory list
    quickInvBody.innerHTML =
      (data.quickInventory || [])
        .slice(0,2)
        .map(item => `
          <tr>
            <td><strong>${item.name}</strong></td>
            <td>${item.qty}</td>
            <td>${formatNGN(item.price)}</td>
          </tr>
        `).join('');

    // recent sales
    recentSalesBody.innerHTML =
      (data.recentSales || [])
        .slice(0,5)
        .map(s => `
          <tr>
            <td>${s.date}</td>
            <td>${s.product}</td>
            <td>${s.qty}</td>
            <td>${formatNGN(s.amount)}</td>
          </tr>
        `).join('');

  } catch (err) {
  stockEl.textContent = 'Error';
  todaySalesEl.textContent = 'Error';
  totalRevenueEl.textContent = 'Error';
  incomingEl.textContent = 'Error';

  console.error('Outlet overview error:', err);
  showToast('Failed to load overview: ' + (err?.message || ''), 'error');
}

}


async function renderOutletInventory(page = 1) {
  curInv = page;
  const tbody = $('#fullInventoryTable tbody');

  try {
    let url = '/api/outlet/inventory';
    if (OUTLET_ID) {
      url += `?outletId=${OUTLET_ID}`;
    }
    console.log('Fetching shipments, page:', page);
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
        console.log('Shipments response:', data);
    fullInventory = data.products || [];

    const start = (curInv - 1) * ITEMS_PER_PAGE;
    const end = start + ITEMS_PER_PAGE;
    const pageItems = fullInventory.slice(start, end);

    tbody.innerHTML = pageItems.map(p => `
      <tr>
        <td><strong>${p.productName}</strong></td>
        <td>${p.sku}</td>
        <td>${p.qty}</td>
        <td>${formatNGN(p.price)}</td>
        <td>${formatNGN(p.qty * p.price)}</td>
        <td> 
          <button class="btn secondary view-history-btn"
                  style="font-size:11px;padding:4px 8px;"
                  data-product-id="${p.productId}"
                  data-product-name="${p.productName || 'Unknown'}">
            View
          </button>
        </td>
      </tr>
    `).join('');

    renderPag($('#inventoryPagination'), fullInventory.length, curInv, n => renderOutletInventory(n));

  } catch (err) {
    tbody.innerHTML = '<tr><td colspan="5">Failed to load inventory</td></tr>';
    console.error('Outlet inventory error:', err);
     showToast('Failed to load inventory: ' + (err?.message || ''), 'error');

  }
}


// Handle "View History" clicks in Outlet Inventory
$('#fullInventoryTable').addEventListener('click', async (e) => {
  const btn = e.target.closest('.view-history-btn');
  if (!btn) return;

  const productId = btn.dataset.productId;
  const productName = btn.dataset.productName;

  navigateTo('productHistory');
  $('#productHistoryTitle').textContent = `Shipment History: ${productName}`;

  const tbody = $('#productHistoryTable tbody');
  tbody.innerHTML = '<tr><td colspan="5" class="muted">Loading history...</td></tr>';

  try {
    const q = new URLSearchParams({
      outletId: OUTLET_ID,
      productId,
      page: 1,           // start at page 1
      limit: ITEMS_PER_PAGE
    });

   const res = await fetch(`/api/product-history?${q}`);
    if (!res.ok) throw new Error(await res.text());

    const { history, totalCount } = await res.json();

    tbody.innerHTML = '';

    if (!history?.length) {
      tbody.innerHTML = '<tr><td colspan="5" class="muted">No shipment history for this product</td></tr>';
    } else {
      history.forEach(h => {
        const qtySign = (h.status === 'Received') ? '+' : '-';
        const qtyColor = (h.status === 'Received') ? 'green' : 'red';
        tbody.innerHTML += `
          <tr>
            <td>${niceDate(h.date)}</td>
            <td>${h.fromName || 'Warehouse'}</td>
            <td style="color:${qtyColor};font-weight:600;">${qtySign}${h.qty}</td>
            <td><span class="pill">${h.status}</span></td>
            <td style="font-family:monospace;">${h.shipmentId?.slice(0,8) || '—'}...</td>
          </tr>
        `;
      });
    }

    // Pagination
    const totalPages = Math.ceil(totalCount / ITEMS_PER_PAGE);
    renderPag($('#historyPagination'), totalCount, 1, (newPage) => {
      // Reload with new page (reuse same productId)
      loadProductHistory(productId, newPage);
    });

  } catch (err) {
    tbody.innerHTML = `<tr><td colspan="5" class="error">Failed: ${err.message}</td></tr>`;
    showToast('Error loading history', 'error');
  }
});

// Helper: Load history for specific page
async function loadProductHistory(productId, page = 1) {
  const tbody = $('#productHistoryTable tbody');
  tbody.innerHTML = '<tr><td colspan="5" class="muted">Loading...</td></tr>';

  try {
    const q = new URLSearchParams({
      outletId: OUTLET_ID,
      productId,
      page,
      limit: ITEMS_PER_PAGE
    });

   const res = await fetch(`/api/product-history?${q}`);
    if (!res.ok) throw new Error(await res.text());

    const { history } = await res.json();

    tbody.innerHTML = history.map(h => {
      const qtySign = (h.status === 'Received') ? '+' : '-';
      const qtyColor = (h.status === 'Received') ? 'green' : 'red';
      return `
        <tr>
          <td>${niceDate(h.date)}</td>
          <td>${h.fromName || 'Warehouse'}</td>
          <td style="color:${qtyColor};font-weight:600;">${qtySign}${h.qty}</td>
          <td><span class="pill">${h.status}</span></td>
          <td style="font-family:monospace;">${h.shipmentId?.slice(0,8) || '—'}...</td>
        </tr>
      `;
    }).join('');

  } catch (err) {
    tbody.innerHTML = `<tr><td colspan="5" class="error">Failed</td></tr>`;
  }
}

async function loadSales(page = 1) {
  curSales = page;
  const start = salesFilter.start || '';
  const end = salesFilter.end || '';
  const q = new URLSearchParams({ page, limit: SALES_PER_PAGE,  outletId: OUTLET_ID });
  if (start) q.set('startDate', start);
  if (end) q.set('endDate', end);

  const tbody = $('#fullSalesTable tbody');
  tbody.innerHTML = '<tr><td colspan="4" class="muted">Loading...</td></tr>';

  try {
    const res = await fetch(`/api/outlet/sales?${q.toString()}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();
    window.lastSalesData = json; 

    if (!json.data || json.data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" class="muted">No sales</td></tr>';
    } else {
let pageGrandTotal = 0; // Calculate grand total for current page

tbody.innerHTML = json.data.map(s => {
  pageGrandTotal += s.totalAmount || 0;

  // Build product names, each on a new line with <br>
  const productLines = s.items && s.items.length > 0
    ? s.items.map(item => `<strong>${item.productName}</strong> × ${item.qty}`).join('<br>')
    : 'No items';

  return `
    <tr>
      <td style="vertical-align:top;">${s.date}</td>
      <td style="vertical-align:top;">${s.time}</td>
      <td style="vertical-align:top; line-height:1.6;">${productLines}</td>
      <td style="vertical-align:top;">${s.totalQty}</td>
      <td style="vertical-align:top;">${formatNGN(s.totalAmount)}</td>
      <td style="white-space:nowrap; vertical-align:top;">
        <button class="btn secondary" style="margin-right:4px;padding:6px 10px;font-size:11px;" onclick="viewSale('${s.id}')">View</button>
        ${currentUser.role === 'admin' ? `
          <button class="btn" style="background:#f59e0b;color:white;margin-right:4px;padding:6px 10px;font-size:11px;" onclick="editSale('${s.id}')">Edit</button>
          <button class="btn" style="background:#dc3545;color:white;padding:6px 10px;font-size:11px;" onclick="confirmDeleteSale('${s.id}')">Delete</button>
        ` : ''}
      </td>
    </tr>
  `;
}).join('') +

// Grand Total Row (fixed at the bottom)
`<tr style="background:#e3f2fd; font-weight:700; border-top:3px double #1976d2;">
  <td colspan="4" style="text-align:right; padding:16px 12px; font-size:15px;">
    Grand Total (this page):
  </td>
  <td style="text-align:left; padding:16px 12px; font-size:15px; color:#0b5ed7;">
    ${formatNGN(pageGrandTotal)}
  </td>
  <td></td>
</tr>`;
    }

    // render pagination UI using your existing renderPag
    renderPag($('#salesPagination'), json.totalCount, curSales, n => loadSales(n));

  } catch (err) {
    tbody.innerHTML = '<tr><td colspan="4">Failed to load sales</td></tr>';
    console.error(err);
    showToast('Failed to load sales: ' + (err?.message || ''), 'error');

  }
}

// initial load
//loadSales(1);






async function renderShipments(page = 1) {
  const tbody = $('#shipmentsTable tbody');
  tbody.innerHTML = `<tr><td colspan="6">Loading...</td></tr>`;

  try {
   const params = new URLSearchParams({
      page: page,
      limit: ITEMS_PER_PAGE
    });

    if (OUTLET_ID) {
      params.append('outletId', OUTLET_ID);
    }

    const url = `/api/outlet-shipments?${params.toString()}`;
    const res = await fetch(url);

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.message || `HTTP ${res.status}`);
    }
    
    const data = await res.json();
    const shipments = data.shipments || [];
    const totalCount = data.totalCount || 0;

    if (!shipments.length) {
      tbody.innerHTML = `<tr><td colspan="6">No shipments yet</td></tr>`;
      return;
    }

   tbody.innerHTML = shipments.map(s => {
  const itemCount = s.products?.length || 1;
  const totalQty = s.products?.reduce((sum, p) => sum + p.qty, 0) || s.qty || 0;
  const totalValue = s.products?.reduce((sum, p) => sum + (p.qty * (p.unitPrice || 0)), 0) || 0;

  return `
    <tr>
      <td>${niceDate(s.date)}</td>
      <td>${s.fromName}</td>
      <td style="text-align:center;"><strong>${itemCount}</strong> item${itemCount > 1 ? 's' : ''}</td>
      <td style="text-align:center;"><strong>${totalQty}</strong></td>
      <td style="text-align:right;">${formatNGN(totalValue)}</td>
      <td><span class="pill">${s.status}</span></td>
      <td style="text-align:center;">
        <button class="btn view-details" style="font-size:11px;padding:5px 10px;background:var(--blue);color:white;border-radius:8px;" data-id="${s.id}">View</button>
        ${s.status === 'In Transit'
          ? `<button class="btn receive-btn" data-id="${s.id}">Receive</button>`
          : ''
        }
      </td>
    </tr>
  `;
}).join('');

    renderPag($('#shipmentsPagination'), totalCount, page, renderShipments);

  } catch (err) {
    tbody.innerHTML = `<tr><td colspan="6">Failed to load shipments</td></tr>`;
    console.error('Shipments error:', err);
    showToast('Failed to load shipments: ' + (err?.message || ''), 'error');
  }
}



$('#shipmentsTable').addEventListener('click', async e => {
  const btn = e.target.closest('.receive-btn');
  if (!btn) return;

  btn.disabled = true; 
  const id = btn.dataset.id;

 //  console.log('Receive button clicked for shipment ID:', id);

  try {
    const res = await fetch(`/api/shipments/approve/${id}`,{
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: 'Received' })
    });

    const data = await res.json();
        console.log('Shipment receive response:', data);
    if (!res.ok) throw new Error(data.message || 'Failed to update status');

    showToast('Shipment marked as received', 'success');

    await renderOutletOverview();
    await renderShipments();

  } catch (err) {
    console.error(err);
     showToast(err?.message || 'An error occurred', 'error');
  } finally {
    btn.disabled = false; 
  }
});




    function renderPag(c,total,cur,cb){
      const pages=Math.ceil(total/ITEMS_PER_PAGE); c.innerHTML='';
      const prev=document.createElement('button'); prev.textContent='← Prev'; prev.disabled=cur===1; prev.onclick=()=>cb(cur-1); c.appendChild(prev);
      for(let i=1;i<=pages;i++){
        if(i===1||i===pages||Math.abs(i-cur)<=2){
          const b=document.createElement('button'); b.textContent=i; b.className=i===cur?'active':''; b.onclick=()=>cb(i); c.appendChild(b);
        }else if(c.lastChild && c.lastChild.textContent!=='...'){
          const d=document.createElement('span'); d.textContent='...'; d.style.padding='0 8px'; c.appendChild(d);
        }
      }
      const next=document.createElement('button'); next.textContent='Next →'; next.disabled=cur===pages; next.onclick=()=>cb(cur+1); c.appendChild(next);
    }

  function applySalesFilter() {
  salesFilter.start = $('#filterStart').value;
  salesFilter.end = $('#filterEnd').value;
  curSales = 1;
  loadSales();
}
   


function clearSalesFilter() {
  $('#filterStart').value = '';
  $('#filterEnd').value = '';
  salesFilter = { start: null, end: null };
  curSales = 1;
  loadSales();
}





    

// Open "Record Sale" modal
$('#recordSaleBtn').onclick = async () => {
  try {
    let url = '/api/outlet/inventory';
    if (OUTLET_ID) url += `?outletId=${OUTLET_ID}`;

    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const data = await res.json();
    OUTLET_ID = data.outletId;

    const products = data.products || [];

    const options = products
      .filter(p => p.qty > 0)
      .map(p => `
        <option 
          value="${p.productId}"
          data-qty="${p.qty}"
          data-price="${p.unitPrice}"
        >
          ${p.productName} (${p.qty} left)
        </option>
      `)
      .join('');

    $('#productSelect').innerHTML = options || `<option>No stock available</option>`;
    $('#qtyInput').value = '';
    $('#successMsg').style.display = 'none';
    $('#modalBackdrop').style.display = 'flex';

  } catch (err) {
    console.error(err);
      showToast(err?.message || 'An error occurred', 'error');
  }
};


// Confirm sale
$('#confirmSale').onclick = async () => {
  const sel = $('#productSelect');
  const qtyInput = $('#qtyInput');

  // Basic safety checks
  if (!sel || !sel.value) return alert('No product selected');
  if (!qtyInput) return alert('Invalid form');

  const productId = sel.value;
  const qty = Number(qtyInput.value);
  const max = Number(sel.selectedOptions[0]?.dataset.qty || 0);

  if (!qty || qty <= 0) return alert('Enter a valid quantity');
  if (qty > max) return alert(`Maximum allowed is ${max}`);


  $('#confirmSale').disabled = true;

  try {
    const res = await fetch('/api/sales', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ outletId: OUTLET_ID, productId, qtySold: qty })
    });

    const data = await res.json();

    if (!res.ok) {
  showToast(data.message || 'An error occurred', 'error');
  return;
}


    // Success updates
    closeModal();
    renderOutletOverview();
    renderOutletInventory();
    loadSales(1);

  } catch (err) {
    console.error(err);
     showToast(err?.message || 'An error occurred', 'error');
  } finally {
    $('#confirmSale').disabled = false;
  }
};


function closeModal() {
  $('#modalBackdrop').style.display = 'none';

  // Reset to normal "Record Sale" mode
  saleCart = [];
  renderCart();
  document.querySelector('#modalBackdrop h3').textContent = 'Record Sale (Multiple Products)';
  $('#confirmSale').textContent = 'Complete Sale';
  $('#confirmSale').style.background = '';
  delete window.currentEditTransactionId;
}
    function closeModal(){$('#modalBackdrop').style.display='none';}
    $('#modalBackdrop').onclick=e=>e.target.id==='modalBackdrop'&&closeModal();





// Multi-product sale logic
let saleCart = [];

async function openMultiSaleModal() {
  saleCart = [];
  renderCart();

  const id = OUTLET_ID || OUTLET_ID;
  if (!id) {
    return showToast('Outlet not selected. Please select an outlet first.', 'error');
  }

  const res = await fetch(`/api/outlet/inventory?outletId=${encodeURIComponent(id)}`);
  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    return showToast(err.message || `Failed to load products (${res.status})`, 'error');
  }
  const data = await res.json();
  OUTLET_ID = data.outletId;

  const options = (data.products || [])
    .filter(p => p.qty > 0)
    .map(p => `
      <option value="${p.productId}"
              data-price="${p.price}"
              data-qty="${p.qty}">
        ${p.productName} (${p.qty} left) — ₦${(p.unitPrice || 0).toLocaleString()}
      </option>
    `).join('');

  $('#productSelect').innerHTML = '<option value="">Select product...</option>' + options;
  $('#successMsg').style.display = 'none';
  $('#modalBackdrop').style.display = 'flex';
}

function renderCart() {
  const tbody = $('#saleItems');
  if (saleCart.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#888;padding:20px;">No items added</td></tr>';
    $('#confirmSale').disabled = true;
    $('#grandTotal').textContent = '₦0';
    return;
  }

  let grandTotal = 0;
  tbody.innerHTML = saleCart.map((item, i) => {
    const total = item.qty * item.price;
    grandTotal += total;
    return `
      <tr>
        <td style="padding:8px;"><strong>${item.name}</strong></td>
        <td><input type="number" min="1" max="${item.max}" value="${item.qty}" 
                   onchange="updateQty(${i}, this.value)" style="width:70px;padding:6px;"></td>
        <td>
  <input type="number"
         step="0.01"
         min="0"
         value="${(item.price || 0).toFixed(2)}"
         onchange="updatePrice(${i}, this.value)"
         style="width:110px; text-align:right; padding:5px 8px; border:1px solid #ddd; border-radius:6px;">
</td>
        <td style="text-align:right;font-weight:600;">₦${total.toLocaleString()}</td>
        <td><button onclick="removeItem(${i})" style="color:var(--dark-red);background:none;border:none;font-size:18px;">×</button></td>
      </tr>
    `;
  }).join('');

  $('#grandTotal').textContent = '₦' + (grandTotal || 0).toLocaleString();
  $('#confirmSale').disabled = false;
}

function updateQty(index, newQty) {
  newQty = parseInt(newQty) || 1;
  if (newQty > saleCart[index].max) newQty = saleCart[index].max;
  saleCart[index].qty = newQty;
  renderCart();
}

function removeItem(index) {
  saleCart.splice(index, 1);
  renderCart();
}



function updatePrice(index, newValue) {
    let price = parseFloat(newValue) || 0;
    if (price < 0) price = 0;

    saleCart[index].price = price;
    renderCart();  // refresh totals & display
}


$('#addItemBtn').onclick = () => {
  const sel = $('#productSelect');
  const qty = parseInt($('#qtyInput').value) || 1;
  if (!sel.value) return showToast('Select a product', 'error');

  const price = parseFloat(sel.selectedOptions[0].dataset.price) || 0;
  const max = parseInt(sel.selectedOptions[0].dataset.qty);
  const name = sel.selectedOptions[0].text.split(' (')[0];

  if (qty > max) return showToast(`Only ${max} available`, 'error');

  const existing = saleCart.findIndex(x => x.productId === sel.value);
  if (existing !== -1) {
    saleCart[existing].qty += qty;
    if (saleCart[existing].qty > max) saleCart[existing].qty = max;
  } else {
    saleCart.push({
    productId: sel.value,
    name,
    price,
    originalPrice: price,   
    qty,
    max
});
  }

  $('#qtyInput').value = 1;
  sel.value = '';
  renderCart();
};

$('#confirmSale').onclick = async () => {
  if (saleCart.length === 0) return;

  $('#confirmSale').disabled = true;
  $('#confirmSale').textContent = 'Processing...';

  try {
    const items = saleCart.map(item => ({
      productId: item.productId,
      qtySold: item.qty,
      unitPrice: item.price
    }));

    console.log('Sending bulk sale items:', JSON.stringify(items, null, 2));

    const res = await fetch('/api/sales/bulk', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ outletId: OUTLET_ID, items })
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.message || 'Sale failed');

    showToast('Sale recorded!', 'success');
    $('#successMsg').style.display = 'block';
    setTimeout(() => {
      closeModal();
      renderOutletOverview();
      renderOutletInventory();
      loadSales(1);
    }, 800);

  } catch (err) {
    showToast(err.message || 'Error', 'error');
  } finally {
    $('#confirmSale').disabled = false;
    $('#confirmSale').textContent = 'Complete Sale';
  }
};

// Change button
$('#recordSaleBtn').onclick = openMultiSaleModal;


function printSale() {
  const printWindow = window.open('', '_blank');
  const date = new Date().toLocaleString();
  const content = `
    <html>
      <head><title>Sale Receipt</title></head,var(--blue);font-family:system-ui;</style></head>
      <body style="padding:20px;">
        <h2 style="text-align:center;">SALE RECEIPT</h2>
        <p style="text-align:center;color:#666;">Date: ${date}</p>
        <table style="width:100%;border-collapse:collapse;margin:20px 0;">
          <thead>
            <tr style="background:#f0f0f0;">
              <th style="text-align:left;padding:10px;border:1px solid #ddd;">Product</th>
              <th style="padding:10px;border:1px solid #ddd;">Qty</th>
              <th style="padding:10px;border:1px solid #ddd;">Price</th>
              <th style="padding:10px;border:1px solid #ddd;">Total</th>
            </tr>
          </thead>
          <tbody>
            ${$('#viewItems').innerHTML}
          </tbody>
        </table>
        <div style="text-align:right;font-size:20px;font-weight:bold;">
          Grand Total: ${$('#viewModal .grand-total').textContent}
        </div>
      </body>
    </html>
  `;
  printWindow.document.write(content);
  printWindow.document.close();
  printWindow.focus();
  printWindow.print();
  printWindow.close();
}


// PRINT OUTLET REP SALES WITH PREVIEW MODAL (SWEET DIE!)
function printOutletSales() {
  const outletName = $('#outletDisplay')?.innerText || 'My Outlet';
  const tableHTML = $('#fullSalesTable').outerHTML;

  const printableContent = `
    <div style="padding:30px; font-family:system-ui,Arial,sans-serif; background:white; color:#111;">
      <h2 style="text-align:center; color:#0b5ed7; margin:0 0 20px; font-size:24px;">
        SALES REPORT
      </h2>
      <div style="text-align:center; color:#555; margin-bottom:25px; font-size:15px;">
        <strong>${outletName}</strong><br>
        Printed on ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}
      </div>

      <style>
        table { width:100%; border-collapse:collapse; margin:20px 0; font-size:13px; }
        th, td { border:1px solid #ddd; padding:10px; text-align:left; }
        th { background:#f0f7ff; color:#111; font-weight:600; }
        tr:nth-child(even) { background:#fafafa; }
      </style>

      ${tableHTML}

      <div style="margin-top:50px; text-align:center; color:#777; font-size:12px;">
        Generated by WareAdmin Outlet Rep
      </div>
    </div>
  `;

  // ← USE THE DEDICATED PRINT MODAL
  document.getElementById('printPreviewContent').innerHTML = printableContent;
  document.getElementById('printPreviewBackdrop').style.display = 'flex';
}

function closePrintPreview() {
  document.getElementById('printPreviewBackdrop').style.display = 'none';
}
function closePrintPreview() {
  document.getElementById('printPreviewBackdrop').style.display = 'none';
}
// CONNECT THE BUTTON
document.getElementById('printOutletSalesBtn')?.addEventListener('click', printOutletSales);


// MAKE PRINT BUTTON WORK — PASTE THIS!
function showModal(html) {
  const modal = document.getElementById('modal');
  const backdrop = document.getElementById('modalBackdrop');
  modal.innerHTML = html;
  backdrop.style.display = 'flex';
}

function closeModal() {
  document.getElementById('modalBackdrop').style.display = 'none';
  saleCart = [];
  renderCart();

  $('#successMsg').style.display = 'none';
}

// THIS MAKES THE PRINT BUTTON WORK
document.getElementById('printOutletSalesBtn')?.addEventListener('click', printOutletSales);

(async () => {
  if (params.get('select')) return; // selector mode active

  // 1️⃣ Priority: URL param (admin/manager)
  if (urlParams.get('outletId')) {
    OUTLET_ID = urlParams.get('outletId');
  } else {
    // 2️⃣ Otherwise, fetch current outlet from session (for reps)
    try {
      const res = await fetch('/api/auth/me');
      if (!res.ok) throw new Error('Failed to fetch user');
      const user = await res.json();
      OUTLET_ID = user.currentOutletId || null;
    } catch (err) {
      console.error('Error fetching current outlet:', err);
      OUTLET_ID = null;
    }
  }

  // 3️⃣ If still no outlet, redirect to select page
  if (!OUTLET_ID) {
    document.body.innerHTML = `
      <div style="text-align:center;padding:80px;background:#f8f9fa;border-radius:12px;">
        <h3>No outlet selected</h3>
        <p><a href="/login.html">Back to login</a></p>
      </div>`;
    return;
  }

  // ✅ Load all data now that OUTLET_ID is correct
  await loadOutletInfo();
  renderOutletOverview();
  renderOutletInventory();
  loadSales();
  renderShipments();
})();


document.addEventListener('click', async (e) => {
  if (e.target.classList.contains('view-details')) {
    const id = e.target.dataset.id;
    if (!id) return showToast('No shipment ID', 'error');

    try {
      const res = await fetch(`/api/shipments/${id}`);
      if (!res.ok) throw new Error('Not found');
      const shipment = await res.json();

      const totalQty = shipment.products.reduce((sum, p) => sum + p.qty, 0);
      const grandTotal = shipment.products.reduce((sum, p) => sum + (p.qty * (p.unitPrice || 0)), 0);

      const backdrop = document.createElement('div');
      backdrop.className = 'modal-backdrop';
      backdrop.style.display = 'flex';

      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.maxWidth = '720px';

      modal.innerHTML = `
        <h3 style="margin:0 0 16px;color:var(--blue);">Shipment Details</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;font-size:14px;">
          <div><strong>Date:</strong> ${niceDate(shipment.date)}</div>
          <div><strong>Status:</strong> <span class="pill">${shipment.status}</span></div>
          <div><strong>From:</strong> ${shipment.from?.name || 'Head Office'}</div>
        </div>

        <h4 style="margin:20px 0 10px;">Products Shipped</h4>
        <table class="inner-table">
          <thead>
            <tr>
              <th>Product</th>
              <th style="text-align:center;">Qty</th>
              <th style="text-align:right;">Unit Price</th>
              <th style="text-align:right;">Line Total</th>
            </tr>
          </thead>
          <tbody>
            ${shipment.products.map(p => {
              const lineTotal = p.qty * (p.unitPrice || 0);
              return `
                <tr>
                  <td><strong>${p.name || p.productName || 'Unknown'}</strong></td>
                  <td style="text-align:center;">${p.qty}</td>
                  <td style="text-align:right;">${formatNGN(p.unitPrice || 0)}</td>
                  <td style="text-align:right;font-weight:600;">${formatNGN(lineTotal)}</td>
                </tr>
              `;
            }).join('')}
            <tr style="font-weight:700;background:#f8fafc;">
              <td>Total</td>
              <td style="text-align:center;">${totalQty}</td>
              <td colspan="2" style="text-align:right;">${formatNGN(grandTotal)}</td>
            </tr>
          </tbody>
        </table>

        <div style="text-align:right;margin-top:20px;">
          <button class="btn" onclick="printShipment(this)">Print Receipt</button>
          <button class="btn secondary" onclick="this.closest('.modal-backdrop').remove()">Close</button>
        </div>
      `;

      window.printShipment = function() {
        const printWin = window.open('', '', 'width=800,height=700');
       printWin.document.write(`
  <!DOCTYPE html>
  <html>
    <head><title>Shipment Receipt</title>
    <style>
      body{font-family:system-ui,sans-serif;padding:40px;color:#111}
      h2{text-align:center;color:#0b5ed7;margin-bottom:30px}
      .info{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:30px;font-size:15px}
      table{width:100%;border-collapse:collapse;margin:20px 0}
      th,td{border:1px solid #ddd;padding:12px;text-align:left}
      th{background:#f8fafc}
      .total-row{font-weight:bold;background:#f0f7ff}
      .grand{font-size:20px;text-align:right;margin-top:30px}
    </style>
    </head>
    <body>
      <h2>SHIPMENT RECEIPT</h2>
      <div class="info">
        <div><strong>Date:</strong> ${niceDate(shipment.date)}</div>
        <div><strong>Status:</strong> ${shipment.status}</div>
        <div><strong>From:</strong> ${shipment.from?.name || 'Warehouse'}</div>
      </div>
      <table>
        <thead><tr><th>Product</th><th style="text-align:center;">Qty</th><th style="text-align:right;">Unit Price</th><th style="text-align:right;">Line Total</th></tr></thead>
        <tbody>
          ${modal.querySelectorAll('table.inner-table tbody tr:not(:last-child)').innerHTML}
          <tr class="total-row">
            <td><strong>Total</strong></td>
            <td style="text-align:center;"><strong>${totalQty}</strong></td>
            <td colspan="2" style="text-align:right;"><strong>${formatNGN(grandTotal)}</strong></td>
          </tr>
        </tbody>
      </table>
      <div class="grand">Grand Total: ${formatNGN(grandTotal)}</div>
    </body>
  </html>
`);
        printWin.document.close();
        printWin.focus();
        printWin.print();
        printWin.close();
      };

      backdrop.appendChild(modal);
      document.body.appendChild(backdrop);
      backdrop.onclick = (ev) => {
        if (ev.target === backdrop) {
          backdrop.remove();
          delete window.printShipment;
        }
      };
    } catch (err) {
      showToast('Failed to load shipment details', 'error');
    }
  }
});


// Edit Sale - Open modal with current items
async function editSale(transactionId) {
  console.log('EDIT CLICKED:', transactionId);
  const sale = window.lastSalesData?.data.find(s => s.id === transactionId);
  console.log('FOUND SALE:', sale);
  if (!sale || !sale.items) return showToast('Sale not found or no items', 'error');

  
  // Load the sold items into cart
  saleCart = sale.items.map(item => ({
    productId: item.productId || item.sku,
    name: item.productName,
    price: item.unitPrice || item.price,
    qty: item.qty,
    max: 99999  // allow any qty during edit
  }));

  console.log('Loaded into saleCart:', saleCart);

  // Load product dropdown (for adding more items if needed)
  try {
    const res = await fetch(`/api/outlet/inventory?outletId=${encodeURIComponent(OUTLET_ID)}`);
    if (!res.ok) throw new Error();
    const data = await res.json();

    const options = (data.products || [])
      .filter(p => p.qty >= 0)
      .map(p => `
        <option value="${p.productId}"
                data-price="${p.unitPrice}"
                data-qty="${p.qty}">
          ${p.productName} (${p.qty} left) — ₦${(p.unitPrice || 0).toLocaleString()}
        </option>
      `).join('');

    $('#productSelect').innerHTML = '<option value="">Select product to add...</option>' + options;
  } catch (err) {
    console.error('Failed to load products for dropdown');
  }

  // NOW OPEN THE MODAL FIRST
  $('#modalBackdrop').style.display = 'flex';

  // THEN RENDER THE CART — now #saleItems exists in DOM
  renderCart();

  // Update UI for edit mode
  document.querySelector('#modalBackdrop h3').textContent = 'Edit Sale';
  $('#confirmSale').textContent = 'Update Sale';
  $('#confirmSale').style.background = '#f59e0b'; // orange to show it's edit

  // Save ID and override button
  window.currentRealTransactionId = sale.transactionId;
  $('#confirmSale').onclick = updateSale;
}


// Update Sale (called when clicking "Update Sale")
async function updateSale() {
  const transactionId = window.currentRealTransactionId;
  if (!transactionId) return showToast('No sale to update', 'error');

  if (saleCart.length === 0) return showToast('No items to save', 'error');

  $('#confirmSale').disabled = true;
  $('#confirmSale').textContent = 'Updating...';

  try {
    const items = saleCart.map(item => ({
      productId: item.productId,
      qtySold: item.qty
    }));

    const res = await fetch(`/api/transactions/${transactionId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ outletId: OUTLET_ID, items })
    });

    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.message || 'Update failed');
    }

    showToast('Sale updated successfully!', 'success');
    closeModal();
    loadSales(curSales);
    renderOutletOverview();
    renderOutletInventory();

  } catch (err) {
    showToast(err.message || 'Failed to update sale', 'error');
  } finally {
    $('#confirmSale').disabled = false;
    $('#confirmSale').textContent = 'Complete Sale';
    delete window.currentEditTransactionId;
    // Restore normal confirm
    $('#confirmSale').onclick = $('#confirmSale').onclick;
  }
}

// Confirm before delete
function confirmDeleteSale(groupId) {
  console.log('Delete clicked for groupId:', groupId); // ← for debugging

  // Safety first
  if (!window.lastSalesData || !window.lastSalesData.data) {
    showToast('Sales data not loaded. Please refresh.', 'error');
    return;
  }

  const sale = window.lastSalesData.data.find(s => s.id === groupId);
  if (!sale) {
    showToast('Sale not found in current data', 'error');
    return;
  }

  const total = formatNGN(sale.totalAmount);
  const realTransactionId = sale.transactionId;

  if (!realTransactionId) {
    showToast('Invalid transaction ID', 'error');
    return;
  }

  const confirmHTML = `
    <div class="modal" style="max-width:400px;text-align:center;">
      <h3 style="color:#dc3545;margin:0 0 16px;">Delete Sale?</h3>
      <p>Are you sure you want to <strong>permanently delete</strong> this sale?</p>
      <div style="background:#f8f9fa;padding:12px;border-radius:8px;margin:16px 0;font-size:14px;">
        <strong>Date:</strong> ${sale.date}<br>
        <strong>Items:</strong> ${sale.itemCount}<br>
        <strong>Total:</strong> ${total}
      </div>
      <p style="color:#dc3545;font-size:13px;"><strong>Cannot be undone.</strong></p>
      <div style="margin-top:20px;">
        <button class="btn secondary" onclick="closeConfirmModal()">Cancel</button>
        <button class="btn" style="background:#dc3545;color:white;margin-left:8px;" 
                onclick="deleteSale('${realTransactionId}'); closeConfirmModal()">
          Yes, Delete
        </button>
      </div>
    </div>
  `;

  const backdrop = document.createElement('div');
  backdrop.className = 'modal-backdrop';
  backdrop.innerHTML = confirmHTML;
  backdrop.style.display = 'flex'; // ← important: show it immediately

  backdrop.onclick = (e) => {
    if (e.target === backdrop) {
      backdrop.remove();
    }
  };

  document.body.appendChild(backdrop);

  window.closeConfirmModal = () => {
    if (backdrop && backdrop.parentNode) {
      backdrop.remove();
    }
    delete window.closeConfirmModal;
  };
}

async function deleteSale(realTransactionId) {
  if (!realTransactionId) {
    showToast('Invalid transaction', 'error');
    return;
  }

  try {
    const res = await fetch(`/api/transactions/${realTransactionId}`, {
      method: 'DELETE'
    });

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.message || 'Delete failed');
    }

    showToast('Sale deleted permanently', 'success');
    loadSales(curSales); // refresh list
    renderOutletOverview();
    renderOutletInventory();

  } catch (err) {
    showToast(err.message || 'Failed to delete sale', 'error');
  }
}


// ─── OUTLET SALES REPORT VARIABLES ────────────────────────────────────────
let outletSalesCurPage = 1;
const OUTLET_SALES_PER_PAGE = 15;
let outletSalesFilter = { start: null, end: null };
let outletSalesPicker = null;

// ─── Date Picker ───────────────────────────────────────────────────────────
function initOutletSalesDatePicker() {
  const container = $('#outletSalesDateContainer');
  if (container.innerHTML) return;

  const input = document.createElement('input');
  input.type = 'text';
  input.placeholder = 'Select date range';
  input.style.cssText = 'height:42px;padding:10px 12px;border:1px solid #e6eefb;border-radius:10px;font-size:14px;min-width:220px;';
  container.appendChild(input);

  outletSalesPicker = flatpickr(input, {
    mode: 'range',
    dateFormat: 'Y-m-d',
    onChange: dates => {
      if (dates.length === 2) {
        const [start, end] = dates.sort((a,b)=>a-b);
        outletSalesFilter.start = start.toISOString().slice(0,10);
        outletSalesFilter.end   = end.toISOString().slice(0,10);
        $('#outletSalesDateDisplay').textContent = `${niceDate(start)} – ${niceDate(end)}`;
      } else {
        outletSalesFilter.start = outletSalesFilter.end = null;
        $('#outletSalesDateDisplay').textContent = 'All time';
      }
      outletSalesCurPage = 1;
      renderOutletSalesReport();
    }
  });
}

// ─── Clear Filters ─────────────────────────────────────────────────────────
function clearOutletSalesFilters() {
  outletSalesFilter = { start: null, end: null };
  $('#outletSalesDateDisplay').textContent = 'All time';
  outletSalesPicker?.clear();
  outletSalesCurPage = 1;
  renderOutletSalesReport();
}

// ─── OUTLET SALES REPORT RENDER (product summary + period display) ────────
async function renderOutletSalesReport(page = 1) {
  outletSalesCurPage = page;
  const tbody = $('#outletSalesReportTable tbody');
  tbody.innerHTML = '<tr><td colspan="5" class="muted">Loading...</td></tr>';

  try {
    const q = new URLSearchParams({
      page,
      limit: OUTLET_SALES_PER_PAGE,
      outletId: OUTLET_ID
    });
    if (outletSalesFilter.start) q.set('startDate', outletSalesFilter.start);
    if (outletSalesFilter.end)   q.set('endDate',   outletSalesFilter.end);
    if (outletSalesFilter.repId) q.set('repId', outletSalesFilter.repId);

    const res = await fetch(`/api/outlet/sales?${q}`);
    const json = await res.json();
    if (!res.ok) throw new Error(json.message || 'Failed');

    // Client-side aggregation: group by product
    const sales = json.data || [];
    const productMap = new Map();

    sales.forEach(s => {
      s.items?.forEach(item => {
        const name = item.productName;
        if (!productMap.has(name)) {
          productMap.set(name, { qty: 0, value: 0 });
        }
        const entry = productMap.get(name);
        entry.qty   += item.qty;
        entry.value += item.qty * (item.unitPrice || 0);
      });
    });

    let productsSold = Array.from(productMap.entries()).map(([name, data]) => ({
      productName: name,
      totalQty:    data.qty,
      totalValue:  data.value
    }));

    // Sort: most sold first
    productsSold.sort((a, b) => b.totalQty - a.totalQty);

    const totalCount = productsSold.length;
    const grandTotalValue = productsSold.reduce((sum, p) => sum + p.totalValue, 0);
    const grandTotalQty   = productsSold.reduce((sum, p) => sum + p.totalQty,   0);

    
    const periodEl = $('#outletCurrentPeriodDisplay');
    if (periodEl) {
      const displayText = $('#outletSalesDateDisplay').textContent.trim();
      if (!displayText || displayText === 'All time') {
        periodEl.textContent = '(All time/Lifetime)';
      } else {
        periodEl.textContent = `(${displayText})`;
      }
    }

    // Render rows
    if (!productsSold.length) {
      tbody.innerHTML = '<tr><td colspan="5" class="muted">No products sold in this period</td></tr>';
    } else {
      tbody.innerHTML = productsSold.map(p => `
        <tr>
          <td style="font-weight:600;">${p.productName}</td>
          <td style="text-align:center; font-weight:600;">${p.totalQty}×</td>
          <td style="text-align:right; font-weight:700; color:var(--blue);">
            ${formatNGN(p.totalValue || 0)}
          </td>
          <td>
  ${outletSalesFilter.repId 
    ? document.querySelector('#repFilter option:checked')?.textContent.trim() || 'Selected Rep'
    : 'Multiple Reps'}
</td>
          <td><span class="pill">Sold</span></td>
        </tr>
      `).join('') + `
        <tr style="background:#e0f2fe; font-weight:700; font-size:14px;">
          <td style="text-align:right; padding-right:12px;">Grand Total:</td>
          <td style="text-align:center;">${grandTotalQty.toLocaleString()} units</td>
          <td style="text-align:right; color:var(--blue);">${formatNGN(grandTotalValue)}</td>
          <td colspan="2"></td>
        </tr>
      `;
    }

    
    renderPag($('#outletSalesPagination'), totalCount, outletSalesCurPage, n => renderOutletSalesReport(n));

  } catch (err) {
    tbody.innerHTML = '<tr><td colspan="5" class="error">Failed to load</td></tr>';
    console.error(err);
    showToast('Error loading outlet sales summary', 'error');
  }
}
// ─── Print Report ──────────────────────────────────────────────────────────
document.getElementById('printOutletSalesReportBtn')?.addEventListener('click', () => {
  const dateRange = $('#outletSalesDateDisplay')?.textContent || 'All time';
  const tableHTML = $('#outletSalesReportTable').outerHTML;

  const printableContent = `
    <div style="padding:40px 30px; font-family:system-ui,Arial,sans-serif; background:white; color:#111827;">
      <h2 style="text-align:center; color:#0b5ed7; margin:0 0 12px; font-size:28px;">
        OUTLET SALES BREAKDOWN REPORT
      </h2>
      <p style="text-align:center; color:#555; margin:0 0 30px; font-size:14px;">
        ${dateRange} • Page ${outletSalesCurPage} • Printed ${new Date().toLocaleString('en-GB')}
      </p>
      <style>
        table { width:100%; border-collapse:collapse; margin:25px 0; font-size:13px; }
        th, td { border:1px solid #d1d5db; padding:10px 8px; text-align:left; }
        th { background:#f0f7ff; color:#111827; font-weight:600; text-transform:uppercase; font-size:11px; }
        tr:nth-child(even) { background:#f9fafb; }
        .pill { padding:4px 10px; border-radius:999px; background:#e0f2fe; color:#0b5ed7; font-weight:600; font-size:11px; }
      </style>
      ${tableHTML}
      <div style="margin-top:60px; text-align:center; color:#6b7280; font-size:12px;">
        Generated by WareAdmin • ${new Date().toLocaleDateString('en-GB')}
      </div>
    </div>
  `;

  // Use your existing print preview modal (or create a simple one)
  showModal(`
    <h4 style="text-align:center; margin:0 0 16px; color:#0b5ed7;">Print Preview – Outlet Sales Report</h4>
    <div style="max-height:75vh; overflow-y:auto; background:white; border:1px solid #e5e7eb; border-radius:12px; padding:24px;">
      ${printableContent}
    </div>
    <div style="text-align:right; margin-top:20px;">
      <button class="btn secondary" onclick="closeModal()">Cancel</button>
      <button class="btn" style="background:#0b5ed7; color:white;" onclick="doPrintOutletReport()">
        Print Now
      </button>
    </div>
  `);

  window.doPrintOutletReport = function() {
    const win = window.open('', '_blank');
    win.document.write(`
      <!DOCTYPE html>
      <html>
      <head><title>Outlet Sales Report</title>
      <style>@page { margin: 1.2cm; } body { font-family: system-ui, Arial, sans-serif; }</style>
      </head>
      <body onload="window.print(); setTimeout(()=>window.close(), 800)">
        ${printableContent}
      </body>
      </html>
    `);
    win.document.close();
    closeModal();
  };
});


async function loadRepFilter() {
  try {
    // Fetch outlet details (includes repIds and repNames)
    const res = await fetch(`/api/outlets/${OUTLET_ID}`);
    if (!res.ok) throw new Error('Failed to load outlet');
    const outlet = await res.json();

    const select = $('#repFilter');
    select.innerHTML = '<option value="">All Reps</option>';

    // Use repNames array (already populated by backend)
    if (outlet.repNames?.length > 0) {
      outlet.repNames.forEach((name, index) => {
        const id = outlet.repIds?.[index]; // match by index
        const opt = document.createElement('option');
        opt.value = id || name; // fallback to name if no id
        opt.textContent = name;
        select.appendChild(opt);
      });
    } else {
      select.innerHTML += '<option disabled>No other reps assigned</option>';
    }

    // Change listener
    select.onchange = () => {
      outletSalesFilter.repId = select.value || null;
      outletSalesCurPage = 1;
      renderOutletSalesReport();
    };

  } catch (err) {
    console.error('Failed to load rep filter', err);
    $('#repFilter').innerHTML = '<option value="">All Reps (error loading)</option>';
  }
}

// Close sidebar when clicking outside it (only on mobile)
document.addEventListener('click', function(e) {
  const sidebar = document.getElementById('sidebar');
  const hambBtn = document.getElementById('hambBtn');

  // Only apply on mobile (where sidebar is off-screen)
  if (window.innerWidth <= 900) {
    // If sidebar is open AND click is NOT on hamburger AND NOT inside sidebar → close it
    if (sidebar.classList.contains('open') &&
        !hambBtn.contains(e.target) &&
        !sidebar.contains(e.target)) {
      sidebar.classList.remove('open');
    }
  }
});



// ─── OUTLET INCOMING SHIPMENT REPORT VARIABLES ────────────────────────────────────────
let outletShipmentCurPage = 1;
const OUTLET_SHIPMENT_PER_PAGE = 15;
let outletShipmentFilter = { start: null, end: null, status: null };
let outletShipmentPicker = null;

// ─── Date Picker ───────────────────────────────────────────────────────────
function initOutletShipmentDatePicker() {
  const container = $('#outletShipmentDateContainer');
  if (container.innerHTML) return;
  const input = document.createElement('input');
  input.type = 'text';
  input.placeholder = 'Select date range';
  input.style.cssText = 'height:42px;padding:10px 12px;border:1px solid #e6eefb;border-radius:10px;font-size:14px;min-width:220px;';
  container.appendChild(input);
  outletShipmentPicker = flatpickr(input, {
    mode: 'range',
    dateFormat: 'Y-m-d',
    onChange: dates => {
      if (dates.length === 2) {
        const [start, end] = dates.sort((a,b)=>a-b);
        outletShipmentFilter.start = start.toISOString().slice(0,10);
        outletShipmentFilter.end = end.toISOString().slice(0,10);
        $('#outletShipmentDateDisplay').textContent = `${niceDate(start)} – ${niceDate(end)}`;
      } else {
        outletShipmentFilter.start = outletShipmentFilter.end = null;
        $('#outletShipmentDateDisplay').textContent = 'All time';
      }
      outletShipmentCurPage = 1;
      renderOutletShipmentReport();
    }
  });
}

// ─── Load Filters (only status) ────────────────────────────────────────────
function loadOutletShipmentFilters() {
  $('#outletShipmentStatusFilter').onchange = () => {
    outletShipmentFilter.status = $('#outletShipmentStatusFilter').value || null;
    outletShipmentCurPage = 1;
    renderOutletShipmentReport();
  };
}

function clearOutletShipmentFilters() {
  outletShipmentFilter = { start: null, end: null, status: null, warehouseId: null };
  $('#outletShipmentDateDisplay').textContent = 'All time';
  outletShipmentPicker?.clear();
  $('#outletShipmentStatusFilter').value = '';
  $('#outletShipmentWarehouseFilter').value = '';
  outletShipmentCurPage = 1;
  renderOutletShipmentReport();
}

// ─── Render Outlet Incoming Shipment Report ─────────────────────────────────
async function renderOutletShipmentReport(page = 1) {
  outletShipmentCurPage = page;
  const tbody = $('#outletShipmentReportTable tbody');
  tbody.innerHTML = '<tr><td colspan="5" class="muted">Loading...</td></tr>';
  try {
    const q = new URLSearchParams({
      outletId: OUTLET_ID,
      page,
      limit: OUTLET_SHIPMENT_PER_PAGE
    });
    if (outletShipmentFilter.warehouseId) {
       q.set('warehouseId', outletShipmentFilter.warehouseId);}
    if (outletShipmentFilter.start) q.set('startDate', outletShipmentFilter.start);
    if (outletShipmentFilter.end) q.set('endDate', outletShipmentFilter.end);
    if (outletShipmentFilter.status) q.set('status', outletShipmentFilter.status);
    const res = await fetch(`/api/outlet/shipments/breakdown?${q}`);
    const json = await res.json();
    if (!res.ok) throw new Error(json.message || 'Failed');
    const shipments = json.data || [];
    const totalCount = json.totalCount || shipments.length;

    // Client-side aggregation: one row per product (only incoming)
    const productMap = new Map();
    shipments.forEach(s => {
      const fromName = s.from?.name || 'Warehouse / Company';
      const status = s.status || '—';
      s.products?.forEach(p => {
        const name = p.name || p.productName || 'Unknown';
        if (!productMap.has(name)) {
          productMap.set(name, {
            totalQty: 0,
            totalValue: 0,
            from: fromName,
            status: status
          });
        }
        const entry = productMap.get(name);
        entry.totalQty += p.qty || 0;
        entry.totalValue += (p.qty || 0) * (p.unitPrice || 0);
        if (entry.status !== status) entry.status = 'All status';
      });
    });

    let aggregated = Array.from(productMap.entries()).map(([name, data]) => ({
      productName: name,
      from: data.from,
      totalQty: data.totalQty,
      totalValue: data.totalValue,
      status: data.status
    }));

    aggregated.sort((a, b) => b.totalQty - a.totalQty);

      updatePeriodDisplay('outletShipmentCurrentPeriodDisplay', 'outletShipmentDateDisplay');
      
      if (!aggregated.length) {
      tbody.innerHTML = '<tr><td colspan="5" class="muted">No incoming shipments in this period</td></tr>';
    } else {
      const grandQty = aggregated.reduce((sum, p) => sum + p.totalQty, 0);
      const grandValue = aggregated.reduce((sum, p) => sum + p.totalValue, 0);
      tbody.innerHTML = aggregated.map(p => `
        <tr>
          <td style="text-align:left;">${p.from}</td>
          <td style="font-weight:600; text-align:left;">${p.productName}</td>
          <td style="text-align:center; font-weight:600;">${p.totalQty}×</td>
          <td style="text-align:right; font-weight:700; color:var(--blue);">
            ${formatNGN(p.totalValue)}
          </td>
          <td><span class="pill">${p.status}</span></td>
        </tr>
      `).join('') + `
        <tr style="background:#e0f2fe; font-weight:700; font-size:14px;">
          <td style="text-align:right; padding-right:12px;">Grand Total:</td>
          <td></td>
          <td style="text-align:center;">${grandQty.toLocaleString()} units</td>
          <td style="text-align:right; color:var(--blue);">${formatNGN(grandValue)}</td>
          <td></td>
        </tr>
      `;
    }

    renderPag($('#outletShipmentPagination'), totalCount, outletShipmentCurPage, n => renderOutletShipmentReport(n));
  } catch (err) {
    tbody.innerHTML = '<tr><td colspan="5" class="error">Failed to load</td></tr>';
    showToast('Error loading incoming shipment report', 'error');
  }
}

// ─── Print ────────────────────────────────────────────────────────────────
document.getElementById('printOutletShipmentReportBtn')?.addEventListener('click', () => {
  const dateRange = $('#outletShipmentDateDisplay')?.textContent || 'All time';
  const tableHTML = $('#outletShipmentReportTable').outerHTML;
  const printable = `
    <div style="padding:40px 30px; font-family:system-ui,Arial,sans-serif;">
      <h2 style="text-align:center; color:#0b5ed7;">INCOMING SHIPMENT BREAKDOWN</h2>
      <p style="text-align:center;color:#555;">${dateRange} • Printed ${new Date().toLocaleString('en-GB')}</p>
      <style>
        table{width:100%;border-collapse:collapse;margin:25px 0;font-size:13px;}
        th,td{border:1px solid #d1d5db;padding:10px 8px;text-align:left;}
        th{background:#f0f7ff;font-weight:600;}
        .pill{padding:4px 10px;border-radius:999px;background:#e0f2fe;color:#0b5ed7;}
      </style>
      ${tableHTML}
      <div style="margin-top:60px;text-align:center;color:#6b7280;font-size:12px;">
        Generated by WareAdmin
      </div>
    </div>
  `;
  showModal(`
    <h4 style="text-align:center;color:#0b5ed7;">Print Preview</h4>
    <div style="max-height:75vh;overflow-y:auto;padding:20px;background:white;border:1px solid #e5e7eb;border-radius:12px;">
      ${printable}
    </div>
    <div style="text-align:right;margin-top:20px;">
      <button class="btn secondary" onclick="closeModal()">Cancel</button>
      <button class="btn" style="background:#0b5ed7;color:white;" onclick="window.printContent('${encodeURIComponent(printable)}')">Print Now</button>
    </div>
  `);
});

window.printContent = str => {
  const win = window.open('', '_blank');
  win.document.write(decodeURIComponent(str));
  win.document.close();
  win.print();
  setTimeout(() => win.close(), 800);
};


function updatePeriodDisplay(periodId, dateDisplayId) {
  const periodEl = document.getElementById(periodId);
  if (!periodEl) return;
  const displayText = document.getElementById(dateDisplayId)?.textContent?.trim() || 'All time';
  periodEl.textContent = (displayText === 'All time' || !displayText)
    ? '(All time / Lifetime)'
    : `(${displayText})`;
}


// ─── Populate Warehouse Filter (unique sources that shipped to this outlet) ────────
async function populateOutletShipmentWarehouseFilter() {
  const select = $('#outletShipmentWarehouseFilter');
  select.disabled = true;
  select.innerHTML = '<option value="">Loading warehouses...</option>';

  try {
    const res = await fetch(`/api/outlet/shipments/warehouses?outletId=${OUTLET_ID}`);
    if (!res.ok) throw new Error();
    const warehouses = await res.json();

    select.innerHTML = '<option value="">All Warehouses</option>';
    warehouses.forEach(w => {
      const opt = document.createElement('option');
      opt.value = w.id;
      opt.textContent = w.name;
      select.appendChild(opt);
    });
  } catch (err) {
    console.error(err);
    select.innerHTML = '<option value="">Warehouses unavailable</option>';
  } finally {
    select.disabled = false;
  }
}
// ─── Update loadOutletShipmentFilters to include warehouse population ──────────────
function loadOutletShipmentFilters() {
  // Date picker already initialized in navigateTo
  $('#outletShipmentStatusFilter').onchange = () => {
    outletShipmentFilter.status = $('#outletShipmentStatusFilter').value || null;
    outletShipmentCurPage = 1;
    renderOutletShipmentReport();
  };

  $('#outletShipmentWarehouseFilter').onchange = () => {
    outletShipmentFilter.warehouseId = $('#outletShipmentWarehouseFilter').value || null;
    outletShipmentCurPage = 1;
    renderOutletShipmentReport();
  };

  // Load warehouses once when filters init
  populateOutletShipmentWarehouseFilter();
}


// Print History Button
$('#printHistoryBtn').addEventListener('click', () => {
  const title = $('#productHistoryTitle').textContent;
  const tableHTML = $('#productHistoryTable').outerHTML;

  const printContent = `
    <div style="padding:40px; font-family:system-ui;">
      <h2 style="text-align:center; color:#0b5ed7;">${title}</h2>
      <p style="text-align:center; color:#555;">Printed ${new Date().toLocaleString('en-GB')}</p>
      <style>
        table { width:100%; border-collapse:collapse; margin:20px 0; }
        th, td { border:1px solid #ddd; padding:10px; text-align:left; }
        th { background:#f0f7ff; font-weight:600; }
      </style>
      ${tableHTML}
    </div>
  `;

  const win = window.open('', '_blank');
  win.document.write(`
    <!DOCTYPE html>
    <html>
    <head><title>Product Shipment History</title></head>
    <body onload="window.print(); setTimeout(()=>window.close(),800)">
      ${printContent}
    </body>
    </html>
  `);
  win.document.close();
});


  </script>
</body>
</html>